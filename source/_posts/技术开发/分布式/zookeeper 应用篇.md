---
title: zookeeper 应用篇
date: 2018/12/18
tags: [分布式]
---

### 实际应用
zookeeper 实际应用非常的广泛，只要涉及到分布式系统中的问题，都可以尝试使用 zookeeper 解决。  

但 zookeeper 不是内存数据库，存储的内容应该都是比较简短的配置信息，zookeeper 的常用应用如下：
- 配置管理中心
- 软负载均衡
- 分布式锁
- master选举
- 分布式队列

#### 1. 配置管理中心
在分布式系统中，多个服务运行在不同的服务器上，这时候再使用 `application.properties` 文件进行配置管理，将会非常的繁琐和易出错。  
使用 zookeeper 做为统一的配置中心，可以实现配置信息动态设置，多服务节点切换等功能。
#####  实现思路
> 开源配置中心实现：disconf

1. 创建统一个节点 `/configure` 作为配置信息的根节点。
2. 客户端启动时拉取`(pull)`所有的子节点，载入到内存进行缓存。
3. 启动后的客户端，对关注的配置节点进行 `watch` 获取到后续动态更新的配置信息`(push)`。
4. 可以按`module`划分配置信息节点树。

#### 2. 分布式锁
在分布式系统中，多个服务对同一资源进行争抢时要用到锁，防止因为并发操作导致数据出现的不一致行为。使用 zookeeper 可以优雅的思想分布式锁，而且性能堪比 redis 实现。
##### 实现思路
> 开源分布式锁实现：curator lock

1. 创建统一节点 `/locks` 作为业务锁的根节点。
2. 当服务执行时，均在 `locks` 下创建临时有序节点。
3. 当前序号最小的节点获得锁，序号大的监听上一个节点的删除事件
4. 当捕获到删除事件，或 `session` 超时(临时节点特性，连接断开删除节点)时，后一个节点获得锁。
5. 可以扩展做读写锁，分类锁，业务模块锁。 

PS：如果使用创建同一节点的方式，会产生羊群效应，因为过多的服务请求涌入而压垮 zookeeper 集群。


#### 3. master 选举
在分布式系统中，为提高可用性通常可以使用冷备或热备的形式进行冗余，master-slaver模式下其实只有一个节点处理事务，而当 master 节点宕机后，热备的 slaver 自动顶替 master 节点进行处理。  
##### 实现思路
> 开源 master选举实现：curator selector

1. 在服务器启动时，均到 zookeeper 参数创建临时节点 `/master`。
2. 创建成功的服务器成为 master, 其它服务器进行事件监听。
3. 当事件触发后，重新进行选举(热备自动切换)。